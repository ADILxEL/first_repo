# ci ame for the product catalog service
name : product_catalog_ci

on: 
    pull_request :
        branches :
         - main
    push :
        branches :
         - main

jobs : 
    build :
         runs-on : ubunto-latest

         steps : 
            - name : checkout code
              uses : actions/checkout@v4
            
            - name : setup go v1.22
              uses : actions/setup-go@v2
              with : 
                go-version : 1.22

            - name : build code 
              run : |
                cd src/product-catalog
                go mod download   
                go build -o product-catalog-srvice main.go  

            - name : unit test
              run : |
                cd src/product-catalog 
                go test ./...
    code-quality :
        runs-on : ubunto-latest

        needs :  build

        steps : 
            - name : checkout code 
              uses : actions/checkout@v4

            - name : go setup v1.22
              uses : actions/setup-go@v2
              with : 
                go-version : 1.22

            - name : run golingci-lint
              uses : golingci/golingci-lint-action@v6
              with :
                version : v1.55.2
                run : golingci-lint run 
                working-directory : src/product-catalog

    docker-login-image-building-and-pushing : 

        runs-on : ubunto-latest

        needs : build 

        steps:
            - name : checkout code 
              uses : actions/checkout@v4
            
            - name : install docker
              uses : docker/setup-buildx-action@v1
             
            - name : login to docker
              uses : docker/docker/login-action@v3
              with : 
                username : ${{secrets.DOCKER_USERNAME}}
                password : ${{secrets.DOCKER_TOKEN}}
            
            - name : image building and pushing
              uses : docker/build-push-action@v6
              with : 
                context : src/product-catalog
                file : src/product-catalog/Dockerfile
                push : true
                tags : ${{secrets.DOCKER_USERNAME}}/product-catalog : ${{github.run_id}}

    Ubdate-k8s-manifists :
        runs-on : ubunto-latest
        needs : [docker-login-image-building-and-pushing , code quality , build] 
        steps :
            - name : chekout code 
              uses : actions/checkout@v4
              with : 
                token : ${{secrets.CHANGE_GITHUB_TOKEN}}
            - name : ubdate k8s manifest
              run : |
                sed -i "s|image: .*|image:${{docker.DOCKER_USERNAME}}/product-catalog-service:${{github.run_id}}|" kubernetes/productcatalog/deploy.yaml

            - name : commit and push changes 
              run : 
                git gonfig --global user.email "adilhihi1232@gmail.com"
                git config --global user.name " adil el hihi"
                git add kubernetes/productcatalog/deploy.yaml
                git commit -m " [CI]:update product catalog image and tag "
                git push oringin main  